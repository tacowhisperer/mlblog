<!DOCTYPE html>
<html>
<head>
	<!-- Look at how quirky this page title is, hire me to do your promotions, please. -->
	<title>Mexico Lindo bLoG</title>

	<!-- Mobile "support" -->
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">

	<!-- Chrome tab color -->
	<meta name="theme-color" content="#000000">

	<!-- Uniform monospace font -->
	<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300&display=swap" rel="stylesheet">
	
	<style>
		* {
			touch-action: manipulation;
		}

		body {
			font-family: 'Inconsolata', monospace;
			-webkit-text-size-adjust: 85%;
		}

		.dropdown {
			display: none;
		}

		p {
			overflow-wrap: break-word;
			line-height: 1.8em;
		}

		h1 {
			cursor: pointer;
			margin-bottom: 0;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		h3 {
			cursor: default;
			font-size: 1em;
			margin-top: 0;
		}

		img {
			width: 100%;
		}

		video {
			width: 100%;
		}
	</style>

	<!-- I guess it would be nice for everything to fucking work lol. -->
	<script type="text/javascript">
		function doubleclick(el, onsingle, ondouble) {
			if (el.getAttribute("data-dblclick") == null) {
				el.setAttribute("data-dblclick", 1);
				setTimeout(function () {
					if (el.getAttribute("data-dblclick") == 1) {
						onsingle(el);
					}
					el.removeAttribute("data-dblclick");
				}, 300);
			} else {
				el.removeAttribute("data-dblclick");
				ondouble(el);
			}
		}

		function fetchJSON(path, callback) {
			const httpRequest = new XMLHttpRequest();

			httpRequest.onreadystatechange = function() {
				if (httpRequest.readyState === 4 && httpRequest.status === 200)
					callback(JSON.parse(httpRequest.responseText));
			};

			httpRequest.open('GET', path);
			httpRequest.send();
		}

		function getMediaExt(mime) {
			switch (mime) {
				case 'audio/aac':
					return '.aac';
				case 'application/x-abiword':
					return '.abw';
				case 'application/x-freearc':
					return '.arc';
				case 'video/x-msvideo':
					return '.avi';
				case 'application/vnd.amazon.ebook':
					return '.azw';
				case 'application/octet-stream':
					return '.bin';
				case 'image/bmp':
					return '.bmp';
				case 'application/x-bzip':
					return '.bz';
				case 'application/x-bzip2':
					return '.bz2';
				case 'application/x-csh':
					return '.csh';
				case 'text/css':
					return '.css';
				case 'text/csv':
					return '.csv';
				case 'application/msword':
					return '.doc';
				case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
					return '.docx';
				case 'application/vnd.ms-fontobject':
					return '.eot';
				case 'application/epub+zip':
					return '.epub';
				case 'application/gzip':
					return '.gz';
				case 'image/gif':
					return '.gif';
				case 'text/html':
					return '.html';
				case 'image/vnd.microsoft.icon':
					return '.ico';
				case 'text/calendar':
					return '.ics';
				case 'application/java-archive':
					return '.jar';
				case 'image/jpeg':
					return '.jpg';
				case 'text/javascript':
					return '.js';
				case 'application/json':
					return '.json';
				case 'application/ld+json':
					return '.jsonld';
				case 'audio/midi</code> <code>audio/x-midi':
					return '.mid';
				case 'audio/midi</code> <code>audio/x-midi':
					return '.midi';
				case 'text/javascript':
					return '.mjs';
				case 'audio/mpeg':
					return '.mp3';
				case 'video/mpeg':
					return '.mpeg';
				case 'video/mp4':
					return '.mp4';
				case 'application/vnd.apple.installer+xml':
					return '.mpkg';
				case 'application/vnd.oasis.opendocument.presentation':
					return '.odp';
				case 'application/vnd.oasis.opendocument.spreadsheet':
					return '.ods';
				case 'application/vnd.oasis.opendocument.text':
					return '.odt';
				case 'audio/ogg':
					return '.oga';
				case 'video/ogg':
					return '.ogv';
				case 'application/ogg':
					return '.ogx';
				case 'audio/opus':
					return '.opus';
				case 'font/otf':
					return '.otf';
				case 'image/png':
					return '.png';
				case 'application/pdf':
					return '.pdf';
				case 'application/x-httpd-php':
					return '.php';
				case 'application/vnd.ms-powerpoint':
					return '.ppt';
				case 'application/vnd.openxmlformats-officedocument.presentationml.presentation':
					return '.pptx';
				case 'application/vnd.rar':
					return '.rar';
				case 'application/rtf':
					return '.rtf';
				case 'application/x-sh':
					return '.sh';
				case 'image/svg+xml':
					return '.svg';
				case 'application/x-shockwave-flash':
					return '.swf';
				case 'application/x-tar':
					return '.tar';
				case 'image/tiff':
					return '.tif';
				case 'image/tiff':
					return '.tiff';
				case 'video/mp2t':
					return '.ts';
				case 'font/ttf':
					return '.ttf';
				case 'text/plain':
					return '.txt';
				case 'application/vnd.visio':
					return '.vsd';
				case 'audio/wav':
					return '.wav';
				case 'audio/webm':
					return '.weba';
				case 'video/webm':
					return '.webm';
				case 'image/webp':
					return '.webp';
				case 'font/woff':
					return '.woff';
				case 'font/woff2':
					return '.woff2';
				case 'application/xhtml+xml':
					return '.xhtml';
				case 'application/vnd.ms-excel':
					return '.xls';
				case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':
					return '.xlsx';
				case 'application/vnd.mozilla.xul+xml':
					return '.xul';
				case 'application/zip':
					return '.zip';
				case 'application/x-7z-compressed':
					return '.7z';
				default:
					return '.txt';
			}
		}

		function getMediaElement(date, mime) {
			const ext = getMediaExt(mime);
			const file = `./www/asset/blog/link/${(new Date(date)).getTime()}${ext}`;

			switch (ext) {
				case '.webp':
				case '.gif':
				case '.png':
				case '.jpg':
					var img = document.createElement('img');
					img.setAttribute('src', file);

					return img;

				case '.mp4':
					var video = document.createElement('video');
					video.setAttribute('playsinline', '');

					var source = document.createElement('source');
					source.setAttribute('src', file);
					source.setAttribute('type', mime);
					video.appendChild(source);

					video.autoplay = true;
					// video.controls = true;
					video.loop = true;
					video.muted = true;

					return video;
				default:
					return document.createElement('div');
			}
		}

		window.addEventListener('load', e => {
			const contentBody = document.getElementById('content');

			// Fetch the blog content
			fetchJSON('./www/mlblogObject.json', function(data) {
				const blogContent = data.blogContent;
				const usr = data.usernameContent;

				function createPost(i, hide = false) {
					// Capture this blog content data
					const blogData = blogContent[i];

					// Holds the contents of this particular blog entry.
					const blogEntry = document.createElement('div');

					const entryTitle = document.createElement('h1');
					entryTitle.appendChild(document.createTextNode(blogData.title));
					entryTitle.addEventListener('click', e => {
						entryTitle.scrollIntoView(true);
					});

					const entryMeta = document.createElement('h3');
					const entryMetaDropdown = document.createElement('span');
					entryMetaDropdown.appendChild(document.createTextNode('â‡• '));
					entryMeta.appendChild(entryMetaDropdown);

					try {
						const entryMetaTxt = `${blogData.date} by ${usr[blogData.username].display}`;
						entryMeta.appendChild(document.createTextNode(entryMetaTxt));
					} catch (e) {
						entryMeta.appendChild(document.createTextNode(`${blogData.date}`));
					}

					const postMeat = () => {
						entryMetaDropdown.classList.add('dropdown');

						// Add the media associated with the post
						const mime = blogData.link.split('`')[1];
						blogEntry.appendChild(getMediaElement(blogData.date, mime));

						const content = blogData.content.split('\n');
						for (let j = 0; j < content.length; j++) {
							const entryContentParagraph = document.createElement('p');
							entryContentParagraph.appendChild(document.createTextNode(content[j]));

							// Add the blog content to the main body for now.
							blogEntry.appendChild(entryContentParagraph);
						}
					};

					// Add the blog entry to their respective parent containers
					blogEntry.appendChild(entryTitle);
					blogEntry.appendChild(entryMeta);
					if (hide) {
						let init = false;
						blogEntry.addEventListener('click', e => {
							if (!init) {
								init = true;
								postMeat();
							}
						});
					} else postMeat();
					contentBody.appendChild(blogEntry);
				}

				const DISP_DAYS = 7

				// Display latest week of posts
				for (let i = 0; i < DISP_DAYS && i < blogContent.length; i++)
					createPost(i, false);

				// Add all other blog entries as collapsed titles
				for (let i = DISP_DAYS; i < blogContent.length; i++)
					createPost(i, true);
			});

			// Populate the blog header
			const contentHead = document.getElementById('header');
			const contentSources = '.'.repeat(4).split('').map((x, i) => {
				return `./www/asset/blog/header/logo_${i + 1}.png`;
			});

			// Background states
			const DARK = false;
			const LIGHT = true;
			let BG_STATE = JSON.parse(window.localStorage.getItem('BG_STATE')) || DARK;

			function setBodyBackground() {
				document.body.style.background = BG_STATE == DARK ? 'black' : 'white';
				document.body.style.color = BG_STATE == DARK ? '#eee' : 'black';
				window.localStorage.setItem('BG_STATE', JSON.stringify(BG_STATE));
			}

			setBodyBackground();
			setTimeout(() => document.body.style.transition = 'all 500ms ease', 750);
			contentHead.parentElement.addEventListener('click', e => doubleclick(contentHead.parentElement, () => {}, () => {
				BG_STATE = !BG_STATE;
				setBodyBackground();
			}));

			let I = 0;
			setInterval(() => contentHead.setAttribute('src', contentSources[I++ % 4]), 1000);
		});
	</script>
</head>

<body>
	<div><img id="header"></div>
	<div id="content"></div>
</body>
</html>
